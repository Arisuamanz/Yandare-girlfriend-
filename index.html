<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rhythm Pad Sprite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            user-select: none; touch-action: none;
        }

        #game-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            background: #000;
        }

        /* Video Background */
        #bg-video {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; object-fit: fill;
            filter: none !important;
        }

        #gameCanvas {
            position: absolute; top: 0; left: 0;
            z-index: 10; touch-action: none;
        }

        .ui-layer {
            position: absolute; z-index: 20; color: white;
            width: 100%; height: 100%; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none;
        }

        .interactive { pointer-events: auto; }

        #menu-screen { background: rgba(0,0,0,0.85); text-align: center; overflow-y: auto; padding: 20px 0; }

        .btn-action {
            background: linear-gradient(135deg, #00ffcc, #0088ff);
            padding: 15px 50px; border-radius: 50px;
            font-weight: 900; font-size: 1.5rem; border: 3px solid white;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.4); margin-top: 15px;
            color: black;
            transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.95); }

        /* COMBO DISPLAY - TOP CENTER */
        #hud-top {
            position: absolute; top: 10px; /* Rapat ke atas */
            left: 50%;
            transform: translateX(-50%); 
            z-index: 30; 
            text-align: center; pointer-events: none;
            display: flex; flex-direction: column; align-items: center;
        }

        .combo-num {
            font-size: 3rem; 
            font-weight: 900; font-style: italic;
            line-height: 1; text-shadow: 0 0 15px rgba(0,0,0,1), 0 0 8px #ff0077;
            color: white;
            transition: transform 0.05s;
        }

        .combo-label {
            font-size: 0.8rem; 
            font-weight: 900; letter-spacing: 4px;
            color: #ff0077; text-shadow: 0 0 8px rgba(0,0,0,1);
            margin-top: 2px;
        }

        .hidden { display: none !important; }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        .fail-shake { animation: shake 0.2s ease-in-out; color: red !important; }

        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 15px; border-radius: 15px;
            margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            width: 85%; max-width: 350px;
        }
        
        .upload-label { font-size: 0.65rem; margin-bottom: 5px; font-weight: bold; color: rgba(255,255,255,0.8); text-transform: uppercase; }
        .upload-input { font-size: 0.7rem; width: 100%; color: white; cursor: pointer; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <video id="bg-video" loop playsinline crossorigin="anonymous"></video>
    <canvas id="gameCanvas"></canvas>

    <!-- UI ATAS (COMBO) -->
    <div id="hud-top" class="hidden">
        <div id="combo-text" class="combo-num">0</div>
        <div class="combo-label">COMBO</div>
    </div>

    <!-- MENU UTAMA -->
    <div id="menu-screen" class="ui-layer interactive">
        <h1 class="text-4xl font-black italic mb-2 text-[#00ffcc] drop-shadow-md">PAD RHYTHM</h1>
        <p class="text-[10px] text-white/50 italic mb-4">Sprites are now your dance pads!</p>
        
        <div class="upload-section">
            <p class="upload-label">1. Video Background (.mp4)</p>
            <input type="file" id="video-upload" accept="video/*" class="upload-input">
        </div>

        <div class="upload-section">
            <p class="upload-label">2. Center Combo Sprite (5x5)</p>
            <input type="file" id="sprite-center-upload" accept="image/*" class="upload-input">
        </div>

        <div class="upload-section">
            <p class="upload-label">3. Left Pad Sprite (5x5)</p>
            <input type="file" id="sprite-left-upload" accept="image/*" class="upload-input">
        </div>

        <div class="upload-section">
            <p class="upload-label">4. Right Pad Sprite (5x5)</p>
            <input type="file" id="sprite-right-upload" accept="image/*" class="upload-input">
        </div>
        
        <button id="start-btn" class="btn-action opacity-50 cursor-not-allowed" disabled>PLAY NOW</button>
    </div>
</div>

<script>
/**
 * PEMBOLEHUBAH GLOBAL & KEDUDUKAN STATIK
 */
const container = document.getElementById('game-container');
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('bg-video');

const videoUpload = document.getElementById('video-upload');
const spriteCenterUpload = document.getElementById('sprite-center-upload');
const spriteLeftUpload = document.getElementById('sprite-left-upload');
const spriteRightUpload = document.getElementById('sprite-right-upload');

const startBtn = document.getElementById('start-btn');
const hud = document.getElementById('hud-top');
const comboEl = document.getElementById('combo-text');

let combo = 0;
let isPlaying = false, lastTime = 0, beatCooldown = 0;
let notes = []; 

// KEDUDUKAN PAD (Dikira semasa resize)
let fixedY = 0;
let leftX = 0;
let rightX = 0;
const PAD_SIZE = 165; // Saiz Gergasi yang diminta

// SPRITE: CENTER (Background Combo)
let spriteCenter = new Image();
let isSpriteCenterLoaded = false;
let frameCenter = 0;
let timerCenter = 0;

// SPRITE: LEFT PAD
let spriteLeft = new Image();
let isSpriteLeftLoaded = false;
let frameLeft = 0;
let timerLeft = 0;

// SPRITE: RIGHT PAD
let spriteRight = new Image();
let isSpriteRightLoaded = false;
let frameRight = 0;
let timerRight = 0;

let currentFPS = 1;

// AUDIO
let audioCtx, analyser, source, dataArray;
let isAudioInitialized = false;

function resize() {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    
    // Tetapkan koordinat statik untuk Pad/Butang
    fixedY = canvas.height * 0.65;
    
    // Pastikan pad tidak terkeluar dari skrin
    const padding = Math.max(85, canvas.width * 0.2); 
    leftX = padding;
    rightX = canvas.width - padding;
}
window.addEventListener('resize', resize);
resize();

// MUAT NAIK FAIL
videoUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        video.src = URL.createObjectURL(file);
        checkReady();
    }
};

spriteCenterUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        spriteCenter.src = URL.createObjectURL(file);
        spriteCenter.onload = () => { isSpriteCenterLoaded = true; checkReady(); };
    }
};

spriteLeftUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        spriteLeft.src = URL.createObjectURL(file);
        spriteLeft.onload = () => { isSpriteLeftLoaded = true; checkReady(); };
    }
};

spriteRightUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
        spriteRight.src = URL.createObjectURL(file);
        spriteRight.onload = () => { isSpriteRightLoaded = true; checkReady(); };
    }
};

function checkReady() {
    if (video.src) {
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

function initAudio() {
    if (isAudioInitialized) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    source = audioCtx.createMediaElementSource(video);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    isAudioInitialized = true;
}

/**
 * KELAS NOTA (VISUAL SANGAT KECIL)
 */
class Note {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        
        // VISUAL BUTANG SANGAT KECIL
        this.visualRadius = 12; 
        
        // HITBOX KEKAL BESAR
        this.hitboxRadius = 70; 
        
        this.approachRadius = 180;
        this.life = 1.0;
        this.shrinkSpeed = 0.33; // Santai (~3 saat)
        this.isFinished = false;
        
        this.color = this.x < canvas.width/2 ? '#ff0077' : '#00ffcc';
    }

    update(dt) {
        this.life -= this.shrinkSpeed * dt;
        this.approachRadius = this.visualRadius + (150 * this.life);
        
        if (this.life <= 0) {
            this.isFinished = true;
            resetCombo(); 
        }
    }

    draw() {
        const op = Math.max(0, this.life);
        
        // Cincin masa
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.approachRadius, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(255, 255, 255, ${op})`;
        ctx.lineWidth = 4;
        ctx.stroke();

        // Titik Butang Sangat Kecil
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.visualRadius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = this.color;
        ctx.fill();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.shadowBlur = 0;
    }
}

/**
 * LOGIK LUKISAN SPRITE
 */
function drawSprites(dt) {
    // KELAJUAN: 0-3 = 1 FPS, 4-7 = 2 FPS...
    let calculatedFPS = Math.floor(combo / 4) + 1;
    currentFPS = Math.min(60, calculatedFPS); 

    // UPDATE TIMERS
    if (isSpriteCenterLoaded) {
        timerCenter += dt;
        if (timerCenter > (1 / currentFPS)) { frameCenter = (frameCenter + 1) % 25; timerCenter = 0; }
    }
    if (isSpriteLeftLoaded) {
        timerLeft += dt;
        if (timerLeft > (1 / currentFPS)) { frameLeft = (frameLeft + 1) % 25; timerLeft = 0; }
    }
    if (isSpriteRightLoaded) {
        timerRight += dt;
        if (timerRight > (1 / currentFPS)) { frameRight = (frameRight + 1) % 25; timerRight = 0; }
    }

    // 1. LUKIS CENTER SPRITE (Background Combo) - Rapat ke atas skrin
    if (isSpriteCenterLoaded) {
        const fW = spriteCenter.width / 5;
        const fH = spriteCenter.height / 5;
        const drawW = PAD_SIZE; 
        const drawH = (fH / fW) * drawW;
        const centerX = canvas.width / 2;

        // Y diubah ke 0 supaya rapat sangat dengan "top edge"
        ctx.drawImage(
            spriteCenter,
            (frameCenter % 5) * fW, Math.floor(frameCenter / 5) * fH, fW, fH,
            centerX - (drawW / 2), 0, drawW, drawH
        );
    }

    // 2. LUKIS LEFT PAD SPRITE
    if (isSpriteLeftLoaded) {
        const fW = spriteLeft.width / 5;
        const fH = spriteLeft.height / 5;
        const drawW = PAD_SIZE; 
        const drawH = (fH / fW) * drawW;

        ctx.drawImage(
            spriteLeft,
            (frameLeft % 5) * fW, Math.floor(frameLeft / 5) * fH, fW, fH,
            leftX - (drawW / 2), fixedY - (drawH / 2), drawW, drawH
        );
    }

    // 3. LUKIS RIGHT PAD SPRITE
    if (isSpriteRightLoaded) {
        const fW = spriteRight.width / 5;
        const fH = spriteRight.height / 5;
        const drawW = PAD_SIZE; 
        const drawH = (fH / fW) * drawW;

        ctx.drawImage(
            spriteRight,
            (frameRight % 5) * fW, Math.floor(frameRight / 5) * fH, fW, fH,
            rightX - (drawW / 2), fixedY - (drawH / 2), drawW, drawH
        );
    }
}

/**
 * ENJIN PERMAINAN
 */
function startGame() {
    initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    video.muted = false;
    video.volume = 1.0;
    video.style.filter = "none";
    
    combo = 0; notes = [];
    isPlaying = true;
    updateComboUI();
    
    document.getElementById('menu-screen').classList.add('hidden');
    hud.classList.remove('hidden');

    video.currentTime = 0;
    video.play();
    
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
}

function gameLoop(currentTime) {
    if (!isPlaying) return;
    const dt = (currentTime - lastTime) / 1000;
    lastTime = currentTime;

    update(dt);
    render(dt);
    requestAnimationFrame(gameLoop);
}

function update(dt) {
    beatCooldown -= dt;

    if (analyser && isPlaying) {
        analyser.getByteFrequencyData(dataArray);
        let bass = 0;
        for (let i = 0; i < 5; i++) bass += dataArray[i];
        bass /= 5;

        if (bass > 215 && beatCooldown <= 0) {
            spawnNote();
            beatCooldown = 0.35; 
            
            video.style.filter = "brightness(1.5) saturate(1.2)";
            setTimeout(() => { if(isPlaying) video.style.filter = "none"; }, 80);
        }
    }

    for (let i = notes.length - 1; i >= 0; i--) {
        notes[i].update(dt);
        if (notes[i].isFinished) notes.splice(i, 1);
    }
}

function spawnNote() {
    const isLeft = Math.random() > 0.5;
    const x = isLeft ? leftX : rightX;
    
    notes.push(new Note(x, fixedY));
}

function render(dt) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    drawSprites(dt);

    for (let i = notes.length - 1; i >= 0; i--) {
        notes[i].draw();
    }
}

/**
 * PENGENDALIAN INPUT
 */
function handleInput(ex, ey) {
    if (!isPlaying) return;
    const rect = canvas.getBoundingClientRect();
    const tx = ex - rect.left;
    const ty = ey - rect.top;

    let hitIdx = -1;
    for (let i = 0; i < notes.length; i++) {
        const n = notes[i];
        const d = Math.hypot(tx - n.x, ty - n.y);
        if (d < n.hitboxRadius) {
            hitIdx = i;
            break; 
        }
    }

    if (hitIdx !== -1) {
        combo++;
        notes.splice(hitIdx, 1);
        updateComboUI();
        playSFX(800);
    } else {
        resetCombo();
    }
}

function resetCombo() {
    if (combo === 0) return;
    combo = 0;
    updateComboUI(true);
    playSFX(150, 'sawtooth');
    
    container.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
    setTimeout(() => container.style.backgroundColor = 'black', 100);
}

function updateComboUI(isFail = false) {
    comboEl.innerText = combo;
    if (isFail) {
        comboEl.classList.add('fail-shake');
        setTimeout(() => comboEl.classList.remove('fail-shake'), 300);
    } else {
        comboEl.style.transform = "scale(1.2)";
        setTimeout(() => comboEl.style.transform = "scale(1)", 50);
    }
}

function playSFX(freq, type = 'sine') {
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.1);
}

// MULTITOUCH ACARA
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    for (let t of e.changedTouches) handleInput(t.clientX, t.clientY);
}, { passive: false });

canvas.addEventListener('mousedown', (e) => handleInput(e.clientX, e.clientY));

startBtn.onclick = startGame;
</script>
</body>
</html>


